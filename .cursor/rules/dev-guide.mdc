---
alwaysApply: true
---

# ä½ æ˜¯ä¸€åé«˜çº§å‰ç«¯æ¶æ„å¸ˆå’Œå¼€å‘å·¥ç¨‹å¸ˆï¼Œå½“æˆ‘è¾“å…¥éœ€æ±‚çš„æ—¶å€™ï¼Œè¯·ä½ æŒ‰ç…§ riper5 è¿›è¡Œåˆ†æã€‚åŒæ—¶éµå¾ªä»¥ä¸‹å†…å®¹ï¼š

## æ ¸å¿ƒæŠ€æœ¯æ ˆçº¦æŸ

### æ¡†æ¶ç‰ˆæœ¬è¦æ±‚

- **Taro**: 4.1.5 (ç¨³å®šç‰ˆæœ¬ï¼Œä¸å¯éšæ„å‡çº§)
- **React**: 18.x (ä½¿ç”¨æ–°çš„ JSX è½¬æ¢)
- **TypeScript**: 5.1.6 (ä¸¥æ ¼æ¨¡å¼)
- **Webpack**: 5.x (æ„å»ºå·¥å…·)

### å¿…é¡»éµå¾ªçš„æŠ€æœ¯é€‰å‹

- **çŠ¶æ€ç®¡ç†**: Zustandæ˜¯å®¢æˆ·ç«¯çŠ¶æ€ç®¡ç† + React Queryæ˜¯APIæœåŠ¡ç«¯æ•°æ®çŠ¶æ€ç®¡ç† (ç¦æ­¢ä½¿ç”¨ Redux)
- **UI ç»„ä»¶**: Taro UI 3.3.0 (ä¼˜å…ˆä½¿ç”¨å®˜æ–¹ç»„ä»¶)
- **æ ·å¼**: SCSS + PostCSS (ç¦æ­¢ä½¿ç”¨ CSS-in-JS)
- **HTTP**: Axios + MSW (å¼€å‘ç¯å¢ƒ Mock)
- **åŒ…ç®¡ç†**: pnpm (ç¦æ­¢ä½¿ç”¨ npm/yarn)
- **ä»£ç è§„èŒƒæ£€æŸ¥**: prettierï¼Œeslintï¼Œstylelint
- **æµ‹è¯•æ¡†æ¶**: Jest
- **é”™è¯¯è¾¹ç•Œ**: React ErrorBoundary
- **å›¾æ ‡ç®¡ç†**: taro-iconfont-cli

## å‚è€ƒæ–‡æ¡£

- **Taro å®˜æ–¹æŠ€æœ¯æ–‡æ¡£**: https://docs.taro.zone/docs/ ä¼˜å…ˆä»¥å®˜æ–¹æ–‡æ¡£çš„ä¸ºå‡†

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **é¿å…åœ¨æ–‡ä»¶ä¸­ç¼–å†™ä¸´æ—¶è„šæœ¬**ï¼Œç‰¹åˆ«æ˜¯åªéœ€è¿è¡Œä¸€æ¬¡çš„æ•°æ®è¿ç§»è„šæœ¬
2. **ä»…æµ‹è¯•ç¯å¢ƒä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®**ï¼Œå¼€å‘ä¸ç”Ÿäº§ç¯å¢ƒä¸¥ç¦ä½¿ç”¨Mockæ•°æ®
3. **ä¿æŒä»£ç ç¨³å®šæ€§**ï¼Œç¡®ä¿ä¿®æ”¹ä¸ä¼šå½±å“å…¶ä»–åŠŸèƒ½çš„æ­£å¸¸è¿è¡Œ
4. **ç¼–è¯‘æ£€æŸ¥**ï¼Œå®ŒæˆåŠŸèƒ½åå¿…é¡»ä¿è¯ç¼–è¯‘æ­£å¸¸
5. **è¿è¡Œæ£€æŸ¥**ï¼Œå®ŒæˆåŠŸèƒ½åå¿…é¡»ä¿è¯æ­£å¸¸è¿è¡Œå’Œè°ƒè¯•
6. **ä»£ç æ ¼å¼å’Œè§„èŒƒæ£€æŸ¥**ï¼Œå®ŒæˆåŠŸèƒ½åè¿è¡Œpnpm checkï¼Œé‡åˆ°è§„èŒƒå’Œæ ¼å¼é—®é¢˜è¯·ä¿®å¤
7. ä½¿ç”¨çœŸå®çš„ UI å›¾ç‰‡ï¼Œè€Œéå ä½ç¬¦å›¾ç‰‡ï¼ˆå¯ä» Unsplashã€Pexelsã€Apple å®˜æ–¹ UI èµ„æºä¸­é€‰æ‹©ï¼‰
8. å½“å‰é¡¹ç›®æ˜¯ä¸ªç§»åŠ¨ç«¯é¡¹ç›®ï¼Œåªéœ€è¦é€‚é…ä¸»æµæ‰‹æœºå³å¯ã€‚å¯é€šè¿‡taroæ¡†æ¶å»æ§åˆ¶ã€‚

## å¼ºåˆ¶æ€§æ£€æŸ¥æµç¨‹

### å¼€å‘å®Œæˆåå¿…é¡»æ‰§è¡Œ

```bash
# 1. ä»£ç è´¨é‡æ£€æŸ¥ (å¿…é¡»é€šè¿‡)
pnpm check

# 2. è‡ªåŠ¨ä¿®å¤é—®é¢˜
pnpm check:fix

# 3. æ„å»ºéªŒè¯
pnpm build:h5

# 4. æµ‹è¯•éªŒè¯
pnpm test
```

### æäº¤å‰æ£€æŸ¥æ¸…å•

- [ ] `pnpm check` æ— é”™è¯¯
- [ ] `pnpm build:h5` æ„å»ºæˆåŠŸ
- [ ] `pnpm test` æµ‹è¯•é€šè¿‡
- [ ] åŠŸèƒ½æ‰‹åŠ¨æµ‹è¯•æ­£å¸¸
- [ ] ä»£ç å·²æ ¼å¼åŒ–

## è·¨å¹³å°å…¼å®¹æ€§è§„åˆ™

### å°ºå¯¸å•ä½è§„èŒƒ

```scss
// âœ… æ¨èï¼šä½¿ç”¨ pxï¼ŒTaro ä¼šè‡ªåŠ¨è½¬æ¢
.container {
  width: 375px;
  height: 200px;
  margin: 20px;
}

// âœ… æ¨èï¼šä½¿ç”¨ç™¾åˆ†æ¯”
.flexible {
  width: 100%;
  height: 50%;
}

// âŒ ç¦æ­¢ï¼šä¸è¦ä½¿ç”¨ remã€emã€vwã€vh
.wrong {
  width: 10rem; // ç¦æ­¢
  height: 50vh; // ç¦æ­¢
}
```

### è®¾è®¡ç¨¿é€‚é…

- **è®¾è®¡ç¨¿å®½åº¦**: 375px (iPhone æ ‡å‡†)
- **è®¾å¤‡æ¯”ä¾‹é…ç½®**: å·²åœ¨ [config/index.ts](mdc:config/index.ts) ä¸­é…ç½®
- **å“åº”å¼**: é€šè¿‡ Taro æ¡†æ¶è‡ªåŠ¨å¤„ç†

### API è°ƒç”¨è§„èŒƒ

```typescript
// âœ… ä½¿ç”¨ç»Ÿä¸€çš„ API æœåŠ¡
import { userApi } from '@/services/api'

// âœ… ä½¿ç”¨ React Query ç®¡ç†çŠ¶æ€
const { data, isLoading } = useQuery({
  queryKey: ['user', userId],
  queryFn: () => userApi.getProfile(userId),
})

// âŒ ç¦æ­¢ç›´æ¥ä½¿ç”¨ Taro.request
Taro.request({ url: '/api/user' }) // ç¦æ­¢
```

## å¹³å°ç‰¹å®šæ³¨æ„äº‹é¡¹

### å°ç¨‹åºé™åˆ¶

- ä¸èƒ½ä½¿ç”¨ `eval()` å’Œ `new Function()`
- ä¸èƒ½åŠ¨æ€åŠ è½½è„šæœ¬
- å›¾ç‰‡èµ„æºéœ€è¦é…ç½®åŸŸåç™½åå•
- éŸ³é¢‘æ’­æ”¾éœ€è¦ç”¨æˆ·äº¤äº’è§¦å‘

### H5 ç‰¹å®š

- æ”¯æŒå®Œæ•´çš„ Web API
- å¯ä»¥ä½¿ç”¨ localStorage
- æ”¯æŒ Service Worker (MSW)

### æƒé™å¤„ç†

```typescript
// âœ… ç»Ÿä¸€çš„æƒé™è¯·æ±‚
import Taro from '@tarojs/taro'

const requestRecordPermission = async () => {
  try {
    const result = await Taro.authorize({
      scope: 'scope.record',
    })
    return result.errMsg === 'authorize:ok'
  } catch (error) {
    // å¤„ç†æƒé™æ‹’ç»
    return false
  }
}
```

## ç»„ä»¶æ¶æ„è§„èŒƒ

### å‡½æ•°ç»„ä»¶è§„èŒƒ

```typescript
// âœ… æ ‡å‡†ç»„ä»¶å®šä¹‰
import React from 'react'
import './index.scss'

interface ButtonProps {
  type?: 'primary' | 'secondary'
  size?: 'small' | 'normal' | 'large'
  disabled?: boolean
  loading?: boolean
  children: React.ReactNode
  onClick?: () => void
}

const Button: React.FC<ButtonProps> = ({
  type = 'primary',
  size = 'normal',
  disabled = false,
  loading = false,
  children,
  onClick
}) => {
  // ç»„ä»¶é€»è¾‘
  return (
    <view className={`button button--${type} button--${size}`}>
      {children}
    </view>
  )
}

export default Button
export type { ButtonProps }
```

### ç»„ä»¶æ–‡ä»¶ç»“æ„

```
components/
â”œâ”€â”€ Button/
â”‚   â”œâ”€â”€ index.tsx      # ç»„ä»¶å®ç°
â”‚   â”œâ”€â”€ index.scss     # ç»„ä»¶æ ·å¼
â”‚   â””â”€â”€ types.ts       # ç±»å‹å®šä¹‰ (å¯é€‰)
```

## çŠ¶æ€ç®¡ç†è§„èŒƒ

### Zustand Store å¼€å‘è§„èŒƒ

#### åŸºç¡€ Store å®šä¹‰

```typescript
// âœ… æ ‡å‡† Store å®šä¹‰
import { create } from 'zustand'
import { persist } from 'zustand/middleware'
import { queryClient } from '@/providers/QueryProvider'
import { QUERY_KEYS } from '@/hooks/useApiQueries'

interface UserState {
  // çŠ¶æ€æ•°æ®
  user: User | null
  isLoggedIn: boolean
  profile: UserProfile

  // Actionsï¼ˆåŠ¨ä½œæ–¹æ³•ï¼‰
  setUser: (user: User) => void
  logout: () => void
  updateProfile: (updates: Partial<UserProfile>) => void
}

export const useUserStore = create<UserState>()(
  persist(
    (set, get) => ({
      // åˆå§‹çŠ¶æ€
      user: null,
      isLoggedIn: false,
      profile: defaultProfile,

      // Actions å®ç°
      setUser: (user: User) => {
        set({ user, isLoggedIn: true })
        // åŒæ­¥æ›´æ–° React Query ç¼“å­˜
        queryClient.setQueryData(QUERY_KEYS.USER_PROFILE(), user)
      },

      logout: () => {
        set({ user: null, isLoggedIn: false })
        // æ¸…é™¤æ‰€æœ‰ç”¨æˆ·ç›¸å…³çš„ç¼“å­˜
        queryClient.removeQueries({ queryKey: QUERY_KEYS.USER })
      },

      updateProfile: (updates: Partial<UserProfile>) => {
        const currentProfile = get().profile
        const updatedProfile = { ...currentProfile, ...updates }
        set({ profile: updatedProfile })
        // ä½¿ç›¸å…³æŸ¥è¯¢å¤±æ•ˆ
        queryClient.invalidateQueries({ queryKey: QUERY_KEYS.USER_STATS })
      },
    }),
    {
      name: 'user-storage',
      // åªæŒä¹…åŒ–å¿…è¦çš„å­—æ®µ
      partialize: state => ({
        user: state.user,
        profile: state.profile,
        isLoggedIn: state.isLoggedIn,
      }),
    }
  )
)
```

#### Zustand æœ€ä½³å®è·µ

```typescript
// âœ… ä½¿ç”¨ immer å¤„ç†å¤æ‚çŠ¶æ€æ›´æ–°
import { immer } from 'zustand/middleware/immer'

export const useComplexStore = create<ComplexState>()(
  immer((set) => ({
    data: { nested: { value: 0 } },
    updateNested: (newValue: number) =>
      set((state) => {
        state.data.nested.value = newValue
      }),
  }))
)

// âœ… çŠ¶æ€åˆ†ç‰‡ - é¿å…å•ä¸ª store è¿‡å¤§
export const useUserStore = create<UserState>()(...) // ç”¨æˆ·ç›¸å…³
export const useTopicStore = create<TopicState>()(...) // è¯é¢˜ç›¸å…³
export const useVocabularyStore = create<VocabularyState>()(...) // è¯æ±‡ç›¸å…³

// âœ… ä½¿ç”¨ subscribeWithSelector è¿›è¡Œç²¾ç¡®è®¢é˜…
import { subscribeWithSelector } from 'zustand/middleware'

export const useStore = create<State>()(
  subscribeWithSelector((set) => ({
    count: 0,
    increment: () => set((state) => ({ count: state.count + 1 })),
  }))
)

// ç»„ä»¶ä¸­ç²¾ç¡®è®¢é˜…
const count = useStore((state) => state.count)
```

#### Zustand ä¸ React Query é›†æˆè§„èŒƒ

```typescript
// âœ… åœ¨ Zustand actions ä¸­åŒæ­¥ React Query ç¼“å­˜
const setTopics: (topics: Topic[]) => {
  set({ topics })
  // åŒæ­¥æ›´æ–° React Query ç¼“å­˜
  queryClient.setQueryData(QUERY_KEYS.TOPICS, topics)
}

// âœ… é¢„å–ç›¸å…³æ•°æ®
const setCurrentTopic: (topic: Topic | null) => {
  set({ currentTopic: topic })
  // é¢„å–è¯é¢˜è¯¦æƒ…
  if (topic) {
    queryClient.prefetchQuery({
      queryKey: QUERY_KEYS.TOPIC_DETAIL(topic.id),
      queryFn: () => topicApi.getTopicDetail(topic.id),
    })
  }
}

// âœ… æ¸…ç†ç¼“å­˜
const logout: () => {
  set({ user: null, isLoggedIn: false })
  // æ¸…é™¤æ‰€æœ‰ç”¨æˆ·ç›¸å…³ç¼“å­˜
  queryClient.removeQueries({ queryKey: QUERY_KEYS.USER })
  queryClient.removeQueries({ queryKey: QUERY_KEYS.USER_STATS })
}
```

### React Query å¼€å‘è§„èŒƒ

#### Query Keys ç®¡ç†

```typescript
// âœ… ç»Ÿä¸€çš„ Query Keys å®šä¹‰
export const QUERY_KEYS = {
  // ç”¨æˆ·ç›¸å…³
  USER: ['user'] as const,
  USER_PROFILE: (userId?: string) => ['user', 'profile', userId] as const,
  USER_STATS: ['user', 'stats'] as const,

  // è¯é¢˜ç›¸å…³
  TOPICS: ['topics'] as const,
  TOPIC_DETAIL: (topicId: string) => ['topics', 'detail', topicId] as const,
  TOPIC_DIALOGUES: (topicId: string) =>
    ['topics', 'dialogues', topicId] as const,

  // è¯æ±‡ç›¸å…³
  VOCABULARIES: ['vocabularies'] as const,
  VOCABULARY_BY_LEVEL: (level: string) =>
    ['vocabularies', 'level', level] as const,
} as const
```

#### æŸ¥è¯¢ Hooks è§„èŒƒ

```typescript
// âœ… æ ‡å‡†æŸ¥è¯¢ Hook
export const useUserInfo = () => {
  return useQuery({
    queryKey: QUERY_KEYS.USER_PROFILE(),
    queryFn: async () => {
      const response = await userApi.getUserInfo()
      return response.data // è¿”å›å®é™…æ•°æ®ï¼Œä¸æ˜¯ ApiResponse åŒ…è£…
    },
    staleTime: 10 * 60 * 1000, // 10åˆ†é’Ÿå†…è®¤ä¸ºæ•°æ®æ˜¯æ–°é²œçš„
    gcTime: 30 * 60 * 1000, // 30åˆ†é’Ÿåæ¸…ç†ç¼“å­˜
  })
}

// âœ… å¸¦å‚æ•°çš„æŸ¥è¯¢
export const useTopics = (category?: string, level?: string) => {
  return useQuery({
    queryKey: [...QUERY_KEYS.TOPICS, { category, level }],
    queryFn: async () => {
      const response = await topicApi.getTopics({ category, level })
      return response.data
    },
    enabled: true, // å¯ä»¥æ ¹æ®æ¡ä»¶æ§åˆ¶æ˜¯å¦å¯ç”¨
    staleTime: 15 * 60 * 1000,
  })
}

// âœ… æ¡ä»¶æŸ¥è¯¢
export const useTopicDetail = (topicId: string) => {
  return useQuery({
    queryKey: QUERY_KEYS.TOPIC_DETAIL(topicId),
    queryFn: async () => {
      const response = await topicApi.getTopicDetail(topicId)
      return response.data
    },
    enabled: !!topicId, // åªæœ‰å½“ topicId å­˜åœ¨æ—¶æ‰æ‰§è¡ŒæŸ¥è¯¢
    staleTime: 30 * 60 * 1000,
  })
}
```

#### å˜æ›´ Hooks è§„èŒƒ

```typescript
// âœ… æ ‡å‡†å˜æ›´ Hook
export const useUpdateUserInfo = () => {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async (userInfo: Partial<User>) => {
      const response = await userApi.updateUserInfo(userInfo)
      return response.data
    },
    onSuccess: data => {
      // æ›´æ–°ç”¨æˆ·ä¿¡æ¯ç¼“å­˜
      queryClient.setQueryData(QUERY_KEYS.USER_PROFILE(), data)
      // ä½¿ç›¸å…³æŸ¥è¯¢å¤±æ•ˆ
      queryClient.invalidateQueries({ queryKey: QUERY_KEYS.USER })
    },
    onError: error => {
      // ç»Ÿä¸€é”™è¯¯å¤„ç†
      console.error('æ›´æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error)
    },
  })
}

// âœ… å¸¦ä¹è§‚æ›´æ–°çš„å˜æ›´
export const useToggleFavorite = () => {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: ({
      topicId,
      isFavorite,
    }: {
      topicId: string
      isFavorite: boolean
    }) => topicApi.toggleFavorite(topicId, isFavorite),

    // ä¹è§‚æ›´æ–°
    onMutate: async ({ topicId, isFavorite }) => {
      // å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„æŸ¥è¯¢
      await queryClient.cancelQueries({ queryKey: QUERY_KEYS.TOPICS })

      // ä¿å­˜ä¹‹å‰çš„æ•°æ®
      const previousTopics = queryClient.getQueryData(QUERY_KEYS.TOPICS)

      // ä¹è§‚æ›´æ–°
      queryClient.setQueryData(QUERY_KEYS.TOPICS, (old: Topic[]) =>
        old?.map(topic =>
          topic.id === topicId ? { ...topic, isFavorite } : topic
        )
      )

      return { previousTopics }
    },

    // é”™è¯¯å›æ»š
    onError: (err, variables, context) => {
      if (context?.previousTopics) {
        queryClient.setQueryData(QUERY_KEYS.TOPICS, context.previousTopics)
      }
    },

    // æœ€ç»ˆåŒæ­¥
    onSettled: () => {
      queryClient.invalidateQueries({ queryKey: QUERY_KEYS.TOPICS })
    },
  })
}
```

#### React Query é…ç½®è§„èŒƒ

```typescript
// âœ… QueryClient é…ç½® - å‚è€ƒ [src/providers/QueryProvider.tsx](mdc:src/providers/QueryProvider.tsx)
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      // æ•°æ®ä¿æŒæ–°é²œçš„æ—¶é—´ï¼ˆ5åˆ†é’Ÿï¼‰
      staleTime: 5 * 60 * 1000,
      // ç¼“å­˜æ—¶é—´ï¼ˆ30åˆ†é’Ÿï¼‰
      gcTime: 30 * 60 * 1000,
      // é‡è¯•é…ç½®
      retry: (failureCount, error: Error) => {
        // ç½‘ç»œé”™è¯¯é‡è¯•ï¼Œå…¶ä»–é”™è¯¯ä¸é‡è¯•
        if (error?.message?.includes('network') && failureCount < 3) {
          return true
        }
        return false
      },
      // é‡è¯•å»¶è¿Ÿï¼ˆæŒ‡æ•°é€€é¿ï¼‰
      retryDelay: attemptIndex => Math.min(1000 * 2 ** attemptIndex, 30000),
      // çª—å£é‡æ–°è·å¾—ç„¦ç‚¹æ—¶ä¸è‡ªåŠ¨é‡æ–°è·å–
      refetchOnWindowFocus: false,
      // ç½‘ç»œé‡è¿æ—¶é‡æ–°è·å–
      refetchOnReconnect: true,
    },
    mutations: {
      // å˜æ›´é‡è¯•é…ç½®
      retry: 1,
    },
  },
})
```

#### æ•°æ®é¢„å–å’Œç¼“å­˜ç­–ç•¥

```typescript
// âœ… æ•°æ®é¢„å–å·¥å…·
export const usePrefetchData = () => {
  const queryClient = useQueryClient()

  const prefetchUserData = (userId?: string) => {
    queryClient.prefetchQuery({
      queryKey: QUERY_KEYS.USER_PROFILE(userId),
      queryFn: () => userApi.getUserInfo(),
    })

    queryClient.prefetchQuery({
      queryKey: QUERY_KEYS.USER_STATS,
      queryFn: () => userApi.getStudyStats(),
    })
  }

  const prefetchTopics = () => {
    queryClient.prefetchQuery({
      queryKey: QUERY_KEYS.TOPICS,
      queryFn: () => topicApi.getTopics({}),
    })
  }

  return { prefetchUserData, prefetchTopics }
}

// âœ… åœ¨ç»„ä»¶ä¸­ä½¿ç”¨é¢„å–
const HomePage = () => {
  const { prefetchTopics } = usePrefetchData()

  useEffect(() => {
    // é¢„å–ç”¨æˆ·å¯èƒ½éœ€è¦çš„æ•°æ®
    prefetchTopics()
  }, [prefetchTopics])

  return <div>...</div>
}
```

#### é”™è¯¯å¤„ç†å’ŒåŠ è½½çŠ¶æ€

```typescript
// âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
const UserProfile = () => {
  const {
    data: userInfo,
    isLoading,
    error,
    refetch
  } = useUserInfo()

  if (isLoading) {
    return <AtLoadMore status="loading" />
  }

  if (error) {
    return (
      <View className="error-container">
        <Text className="error-text">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</Text>
        <View className="retry-button" onClick={() => refetch()}>
          é‡è¯•
        </View>
      </View>
    )
  }

  return (
    <View>
      <Text>{userInfo?.nickname}</Text>
    </View>
  )
}

// âœ… å˜æ›´çŠ¶æ€å¤„ç†
const UpdateButton = () => {
  const updateUser = useUpdateUserInfo()

  const handleUpdate = async () => {
    try {
      await updateUser.mutateAsync({ nickname: 'æ–°æ˜µç§°' })
      Taro.showToast({ title: 'æ›´æ–°æˆåŠŸ', icon: 'success' })
    } catch (error) {
      Taro.showToast({ title: 'æ›´æ–°å¤±è´¥', icon: 'error' })
    }
  }

  return (
    <button
      onClick={handleUpdate}
      disabled={updateUser.isPending}
    >
      {updateUser.isPending ? 'æ›´æ–°ä¸­...' : 'æ›´æ–°'}
    </button>
  )
}
```

### çŠ¶æ€ç®¡ç†æ¶æ„åŸåˆ™

#### æ•°æ®æµè®¾è®¡

```
ç”¨æˆ·æ“ä½œ â†’ Zustand Action â†’ åŒæ­¥ React Query ç¼“å­˜ â†’ UI æ›´æ–°
     â†“
API è°ƒç”¨ â†’ React Query Hook â†’ è‡ªåŠ¨ç¼“å­˜ â†’ åå°æ›´æ–°
```

#### èŒè´£åˆ†ç¦»

- **Zustand**: ç®¡ç†å®¢æˆ·ç«¯çŠ¶æ€ï¼ˆUI çŠ¶æ€ã€ç”¨æˆ·åå¥½ã€ä¸´æ—¶æ•°æ®ï¼‰
- **React Query**: ç®¡ç†æœåŠ¡ç«¯çŠ¶æ€ï¼ˆAPI æ•°æ®ã€ç¼“å­˜ã€åŒæ­¥ï¼‰
- **åŒå‘åŒæ­¥**: Zustand æ›´æ–°æ—¶åŒæ­¥ React Queryï¼ŒReact Query æ•°æ®å˜æ›´æ—¶å¯é€‰æ‹©æ€§æ›´æ–° Zustand

#### ç¼“å­˜ç­–ç•¥

```typescript
// âœ… ä¸åŒæ•°æ®çš„ç¼“å­˜ç­–ç•¥
const cacheStrategies = {
  // ç”¨æˆ·ä¿¡æ¯ - é•¿ç¼“å­˜
  userInfo: { staleTime: 30 * 60 * 1000, gcTime: 60 * 60 * 1000 },

  // è¯é¢˜åˆ—è¡¨ - ä¸­ç­‰ç¼“å­˜
  topics: { staleTime: 15 * 60 * 1000, gcTime: 30 * 60 * 1000 },

  // èŠå¤©æ¶ˆæ¯ - çŸ­ç¼“å­˜
  chatMessages: { staleTime: 2 * 60 * 1000, gcTime: 10 * 60 * 1000 },

  // å®æ—¶æ•°æ® - ä¸ç¼“å­˜
  liveData: { staleTime: 0, gcTime: 0 },
}
```

## API å’Œ Mock å¼€å‘è§„èŒƒ

### MSW Mock æœåŠ¡è§„èŒƒ

```typescript
// âœ… ç¯å¢ƒæ£€æµ‹ - å‚è€ƒ [src/app.ts](mdc:src/app.ts)
const isDev = process.env.NODE_ENV === 'development'

// åªåœ¨å¼€å‘ç¯å¢ƒå¯ç”¨ MSW
if (isDev || window.location.hostname === 'localhost') {
  import('./mocks/browser').then(({ startWorker }) => {
    startWorker()
  })
}
```

### Mock Handler å®šä¹‰

```typescript
// âœ… æ ‡å‡† Mock Handler - å‚è€ƒ [src/mocks/handlers/user.ts](mdc:src/mocks/handlers/user.ts)
import { http, HttpResponse } from 'msw'
import type { User } from '@/types'

export const userHandlers = [
  // GET è¯·æ±‚
  http.get('/api/user/profile', ({ request }) => {
    const url = new URL(request.url)
    const userId = url.searchParams.get('userId')

    return HttpResponse.json({
      code: 200,
      message: 'success',
      data: mockUser,
    })
  }),

  // POST è¯·æ±‚
  http.post('/api/user/update', async ({ request }) => {
    const body = await request.json()

    return HttpResponse.json({
      code: 200,
      message: 'success',
      data: { ...mockUser, ...body },
    })
  }),
]
```

### HTTP å®¢æˆ·ç«¯é…ç½®

```typescript
// âœ… HTTP å®¢æˆ·ç«¯ - å‚è€ƒ [src/services/http.ts](mdc:src/services/http.ts)
class HttpClient {
  private instance: AxiosInstance

  constructor() {
    this.instance = axios.create({
      baseURL: config.apiConfig.baseURL,
      timeout: config.apiConfig.timeout,
    })

    this.setupInterceptors()
  }

  private setupInterceptors() {
    // è¯·æ±‚æ‹¦æˆªå™¨
    this.instance.interceptors.request.use(config => {
      // æ·»åŠ è®¤è¯ token
      const token = getStorage('token')
      if (token) {
        config.headers.Authorization = `Bearer ${token}`
      }
      return config
    })

    // å“åº”æ‹¦æˆªå™¨
    this.instance.interceptors.response.use(
      response => response.data,
      error => {
        // ç»Ÿä¸€é”™è¯¯å¤„ç†
        return Promise.reject(error)
      }
    )
  }
}
```

## æ ·å¼è§„èŒƒ

### SCSS å‘½åè§„èŒƒ (BEM)

```scss
// âœ… BEM å‘½åè§„èŒƒ
.button {
  // åŸºç¡€æ ·å¼

  &--primary {
    // ä¿®é¥°ç¬¦æ ·å¼
  }

  &--large {
    // å°ºå¯¸ä¿®é¥°ç¬¦
  }

  &__icon {
    // å…ƒç´ æ ·å¼
  }

  &--disabled {
    // çŠ¶æ€ä¿®é¥°ç¬¦
  }
}
```

### å“åº”å¼è®¾è®¡

```scss
// âœ… ç§»åŠ¨ç«¯ä¼˜å…ˆ
.container {
  padding: 20px;

  // ä½¿ç”¨ Taro çš„å“åº”å¼ mixin
  @media (min-width: 768px) {
    padding: 40px;
  }
}
```

### ç¦æ­¢çš„æ ·å¼å†™æ³•

```scss
// âŒ ç¦æ­¢ä½¿ç”¨ !important
.button {
  color: red !important; // ç¦æ­¢
}

// âŒ ç¦æ­¢ä½¿ç”¨å†…è”æ ·å¼ (é™¤éåŠ¨æ€è®¡ç®—)
<div style="color: red"> // ç¦æ­¢

// âŒ ç¦æ­¢ä½¿ç”¨éæ ‡å‡†å•ä½
.container {
  width: 10rem; // ç¦æ­¢ï¼Œä½¿ç”¨ px
  height: 50vh; // ç¦æ­¢ï¼Œä½¿ç”¨ px
}
```

## TypeScript ä¸¥æ ¼æ¨¡å¼

### ç±»å‹å®šä¹‰è¦æ±‚

```typescript
// âœ… å®Œæ•´çš„æ¥å£å®šä¹‰
interface ButtonProps {
  type?: 'primary' | 'secondary' | 'danger'
  size?: 'small' | 'medium' | 'large'
  disabled?: boolean
  loading?: boolean
  children: React.ReactNode
  onClick?: (event: React.MouseEvent<HTMLButtonElement>) => void
}

// âœ… æ³›å‹ä½¿ç”¨
interface ApiResponse<T> {
  code: number
  message: string
  data: T
}

// âœ… è”åˆç±»å‹
type Theme = 'light' | 'dark'
type UserRole = 'admin' | 'user' | 'guest'
```

### ç¦æ­¢çš„ç±»å‹ä½¿ç”¨

```typescript
// âŒ ç¦æ­¢ä½¿ç”¨ any
const data: any = {} // ç¦æ­¢

// âŒ ç¦æ­¢ä½¿ç”¨ object
const config: object = {} // ç¦æ­¢ï¼Œä½¿ç”¨å…·ä½“æ¥å£

// âŒ ç¦æ­¢ä½¿ç”¨ Function
const callback: Function = () => {} // ç¦æ­¢ï¼Œä½¿ç”¨å…·ä½“å‡½æ•°ç­¾å
```

## ç§»åŠ¨ç«¯ä¼˜åŒ–è§„èŒƒ

### è§¦æ‘¸å‹å¥½è®¾è®¡

```scss
// âœ… æœ€å°è§¦æ‘¸ç›®æ ‡ 44px
.touch-target {
  min-height: 44px;
  min-width: 44px;

  // è§¦æ‘¸åé¦ˆ
  &:active {
    opacity: 0.7;
    transform: scale(0.98);
  }
}
```

### æ€§èƒ½ä¼˜åŒ–

```typescript
// âœ… å›¾ç‰‡æ‡’åŠ è½½
import { Image } from '@tarojs/components'

const OptimizedImage: React.FC<ImageProps> = ({
  src,
  placeholder,
  ...props
}) => {
  return (
    <Image
      src={src}
      lazyLoad
      mode="aspectFit"
      placeholder={placeholder}
      onError={(e) => {
        console.warn('å›¾ç‰‡åŠ è½½å¤±è´¥:', e)
      }}
      {...props}
    />
  )
}
```

### éŸ³é¢‘å¤„ç†ä¼˜åŒ–

```typescript
// âœ… å½•éŸ³æƒé™å’ŒåŠŸèƒ½
const useRecording = () => {
  const [isRecording, setIsRecording] = useState(false)

  const startRecording = useCallback(async () => {
    try {
      // è¯·æ±‚å½•éŸ³æƒé™
      const authorized = await Taro.authorize({
        scope: 'scope.record',
      })

      if (authorized.errMsg !== 'authorize:ok') {
        throw new Error('å½•éŸ³æƒé™è¢«æ‹’ç»')
      }

      // å¼€å§‹å½•éŸ³
      const recorderManager = Taro.getRecorderManager()
      recorderManager.start({
        duration: 60000, // æœ€é•¿60ç§’
        sampleRate: 16000,
        numberOfChannels: 1,
        encodeBitRate: 48000,
        format: 'mp3',
      })

      setIsRecording(true)
    } catch (error) {
      console.error('å½•éŸ³å¯åŠ¨å¤±è´¥:', error)
      Taro.showToast({
        title: 'å½•éŸ³åŠŸèƒ½ä¸å¯ç”¨',
        icon: 'none',
      })
    }
  }, [])

  return { isRecording, startRecording }
}
```

## é”™è¯¯å¤„ç†æ ‡å‡†

### é¡µé¢çº§é”™è¯¯è¾¹ç•Œ

```typescript
// å‚è€ƒ [src/components/ErrorBoundary/PageErrorBoundary.tsx](mdc:src/components/ErrorBoundary/PageErrorBoundary.tsx)
export const withPageErrorBoundary = <P extends object>(
  Component: React.ComponentType<P>
) => {
  return (props: P) => (
    <PageErrorBoundary>
      <Component {...props} />
    </PageErrorBoundary>
  )
}
```

### ç»„ä»¶å†…é”™è¯¯å¤„ç†

```typescript
const UserProfile = ({ userId }) => {
  const { data, error, isLoading } = useQuery({
    queryKey: ['user', userId],
    queryFn: () => userApi.getProfile(userId),
    onError: (error) => {
      handleApiError(error, { context: 'UserProfile' })
    }
  })

  if (error) {
    return <ErrorMessage message="åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥" />
  }

  return <div>{data?.name}</div>
}
```

## æ–‡ä»¶ç»„ç»‡è§„èŒƒ

### ç›®å½•ç»“æ„è¦æ±‚

```
src/
â”œâ”€â”€ components/          # ç»„ä»¶ç›®å½•
â”‚   â”œâ”€â”€ common/         # é€šç”¨ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ Button/
â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ index.scss
â”‚   â”‚   â”‚   â””â”€â”€ types.ts
â”‚   â”‚   â””â”€â”€ Modal/
â”‚   â””â”€â”€ business/       # ä¸šåŠ¡ç»„ä»¶
â”œâ”€â”€ pages/              # é¡µé¢ç›®å½•
â”‚   â”œâ”€â”€ user/
â”‚   â”‚   â”œâ”€â”€ index.tsx
â”‚   â”‚   â”œâ”€â”€ index.scss
â”‚   â”‚   â””â”€â”€ index.config.ts
â”œâ”€â”€ services/           # API æœåŠ¡
â”œâ”€â”€ stores/            # çŠ¶æ€ç®¡ç†
â”œâ”€â”€ utils/             # å·¥å…·å‡½æ•°
â””â”€â”€ types/             # ç±»å‹å®šä¹‰
```

### æ–‡ä»¶å‘½åè§„èŒƒ

- **ç»„ä»¶æ–‡ä»¶**: PascalCase (Button.tsx, UserProfile.tsx)
- **é¡µé¢æ–‡ä»¶**: kebab-case (user-profile/index.tsx)
- **å·¥å…·æ–‡ä»¶**: camelCase (dateUtils.ts, apiHelper.ts)
- **ç±»å‹æ–‡ä»¶**: camelCase (userTypes.ts, apiTypes.ts)

## æ€§èƒ½è¦æ±‚

### ç»„ä»¶æ€§èƒ½ä¼˜åŒ–

```typescript
// âœ… ä½¿ç”¨ React.memo é¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
const UserCard = React.memo<UserCardProps>(({ user, onSelect }) => {
  const handleClick = useCallback(() => {
    onSelect(user.id)
  }, [user.id, onSelect])

  return (
    <div onClick={handleClick}>
      {user.name}
    </div>
  )
})

// âœ… ä½¿ç”¨ useMemo ç¼“å­˜è®¡ç®—ç»“æœ
const ExpensiveComponent = ({ items }) => {
  const processedItems = useMemo(() => {
    return items.map(item => ({
      ...item,
      processed: expensiveCalculation(item)
    }))
  }, [items])

  return <div>{processedItems.map(renderItem)}</div>
}
```

### ä»£ç åˆ†å‰²

```typescript
// âœ… é¡µé¢çº§ä»£ç åˆ†å‰²
const LazyUserPage = lazy(() => import('@/pages/user'))
const LazySettingsPage = lazy(() => import('@/pages/settings'))

// âœ… ç»„ä»¶çº§ä»£ç åˆ†å‰² (å¤§å‹ç»„ä»¶)
const LazyChart = lazy(() => import('@/components/Chart'))
```

## æµ‹è¯•è¦æ±‚

### å•å…ƒæµ‹è¯•è¦†ç›–ç‡

- **æœ€ä½è¦æ±‚**: 70%
- **ç›®æ ‡è¦†ç›–ç‡**: 80%+
- **å…³é”®ç»„ä»¶**: 90%+

### æµ‹è¯•æ–‡ä»¶ç»„ç»‡

```
__tests__/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ Button.test.tsx
â”‚   â””â”€â”€ Modal.test.tsx
â”œâ”€â”€ pages/
â”‚   â””â”€â”€ UserProfile.test.tsx
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ dateUtils.test.ts
â””â”€â”€ services/
    â””â”€â”€ api.test.ts
```

## æäº¤è§„èŒƒ

### Git Commit æ¶ˆæ¯æ ¼å¼

```bash
# âœ… æ ‡å‡†æ ¼å¼
feat: æ·»åŠ ç”¨æˆ·å¤´åƒä¸Šä¼ åŠŸèƒ½
fix: ä¿®å¤ç™»å½•é¡µé¢éªŒè¯ç åˆ·æ–°é—®é¢˜
style: ä¼˜åŒ–æŒ‰é’®ç»„ä»¶æ ·å¼
refactor: é‡æ„ç”¨æˆ·çŠ¶æ€ç®¡ç†é€»è¾‘
test: æ·»åŠ ç”¨æˆ·æœåŠ¡å•å…ƒæµ‹è¯•
docs: æ›´æ–° API æ–‡æ¡£

# âŒ ä¸è§„èŒƒçš„æäº¤æ¶ˆæ¯
git commit -m "fix bug"        # å¤ªç®€å•
git commit -m "å„ç§ä¿®æ”¹"        # ä¸æ˜ç¡®
git commit -m "WIP"           # ä¸åº”æäº¤æœªå®Œæˆä»£ç 
```

## é€šç”¨å¼€å‘åŸåˆ™

- **å¼€å‘åº§å³é“­**: ç®€å•ã€é‡ç”¨ã€ç¨³å®šã€å¯ç»´æŠ¤ ğŸ¯
- å§‹ç»ˆä¼˜å…ˆé€‰æ‹©ç®€å•æ–¹æ¡ˆ
- å°½å¯èƒ½é¿å…ä»£ç é‡å¤
  â€ƒâ€ƒâ€¢ ä¿®æ”¹ä»£ç å‰ï¼Œæ£€æŸ¥ä»£ç åº“ä¸­æ˜¯å¦å·²å­˜åœ¨ç›¸ä¼¼åŠŸèƒ½æˆ–é€»è¾‘ã€‚
- ç¼–å†™ä»£ç æ—¶éœ€åŒºåˆ†ä¸åŒç¯å¢ƒ
  â€ƒâ€ƒâ€¢ æ˜ç¡®åŒºåˆ†å¼€å‘ç¯å¢ƒï¼ˆdevï¼‰ã€æµ‹è¯•ç¯å¢ƒï¼ˆtestï¼‰å’Œç”Ÿäº§ç¯å¢ƒï¼ˆprodï¼‰ã€‚
- è°¨æ…ä¿®æ”¹ä»£ç 
  â€ƒâ€ƒâ€¢ ä»…é’ˆå¯¹æ˜ç¡®éœ€æ±‚è¿›è¡Œæ›´æ”¹ï¼Œæˆ–ç¡®ä¿ä¿®æ”¹å†…å®¹ä¸éœ€æ±‚å¼ºç›¸å…³ä¸”å·²è¢«å……åˆ†ç†è§£ã€‚
- ä¿®å¤é—®é¢˜æ—¶é¿å…å¼•å…¥æ–°æŠ€æœ¯/æ¨¡å¼
  â€ƒâ€ƒâ€¢ ä¼˜å…ˆå½»åº•æ’æŸ¥ç°æœ‰å®ç°çš„å¯èƒ½æ€§ï¼Œè‹¥å¿…é¡»å¼•å…¥æ–°æ–¹æ¡ˆï¼Œéœ€åŒæ­¥ç§»é™¤æ—§é€»è¾‘ä»¥é¿å…å†—ä½™ã€‚
- ä¿æŒä»£ç åº“æ•´æ´æœ‰åº
- æ§åˆ¶å•æ–‡ä»¶ä»£ç è¡Œæ•°
  â€ƒâ€ƒâ€¢ æ–‡ä»¶ä»£ç è¶…è¿‡ 200-300è¡Œ æ—¶éœ€é‡æ„å°è£…ã€‚
- **æ¶æ„è®¾è®¡**ï¼šè€ƒè™‘ä»£ç çš„å¯ç»´æŠ¤æ€§ã€å¯æ‰©å±•æ€§å’Œæ€§èƒ½éœ€æ±‚
- **å‘½åè§„èŒƒ**ï¼šä½¿ç”¨æè¿°æ€§çš„å˜é‡ã€å‡½æ•°å’Œç±»åï¼Œåæ˜ å…¶ç”¨é€”å’Œå«ä¹‰
- **DRY åŸåˆ™**ï¼šé¿å…é‡å¤ä»£ç ï¼Œæå–å…±ç”¨é€»è¾‘åˆ°å•ç‹¬çš„å‡½æ•°æˆ–ç±»
- **æ³¨é‡Šæ–‡æ¡£**ï¼šä¸ºå¤æ‚é€»è¾‘æ·»åŠ æ³¨é‡Šï¼Œç¼–å†™æ¸…æ™°çš„æ–‡æ¡£è¯´æ˜åŠŸèƒ½å’Œç”¨æ³•
- **é£æ ¼ä¸€è‡´**ï¼šéµå¾ªé¡¹ç›®æˆ–è¯­è¨€çš„å®˜æ–¹é£æ ¼æŒ‡å—å’Œä»£ç çº¦å®š
- **åˆ©ç”¨ç”Ÿæ€**ï¼šä¼˜å…ˆä½¿ç”¨æˆç†Ÿçš„åº“å’Œå·¥å…·ï¼Œé¿å…ä¸å¿…è¦çš„è‡ªå®šä¹‰å®ç°ã€‚æ¯”å¦‚taroæœ‰å¾ˆå¤šæ’ä»¶å’Œç»„ä»¶å¯ä»¥ä¼˜å…ˆä½¿ç”¨ã€‚
- **å¼‚å¸¸å¤„ç†**ï¼šæ­£ç¡®å¤„ç†è¾¹ç¼˜æƒ…å†µå’Œé”™è¯¯ï¼Œæä¾›æœ‰ç”¨çš„é”™è¯¯ä¿¡æ¯ ï¼Œå¯é€šè¿‡react é”™è¯¯è¾¹ç•Œçš„æ¦‚å¿µå®ç°
- åœ¨ Taro ä¸­å°ºå¯¸å•ä½å»ºè®®ä½¿ç”¨ pxã€ ç™¾åˆ†æ¯” %ï¼ŒTaro é»˜è®¤ä¼šå¯¹æ‰€æœ‰å•ä½è¿›è¡Œè½¬æ¢
- **mockæ¥å£**ï¼šåŸºäºå‰åç«¯åˆ†ç¦»å¼€å‘åŸåˆ™ï¼Œå‰ç«¯é€šè¿‡MSW,è¿›è¡Œæ¥å£mockã€‚

## ç”Ÿäº§ç¯å¢ƒæ³¨æ„äº‹é¡¹

### ç¦æ­¢äº‹é¡¹

- âŒ ç”Ÿäº§ç¯å¢ƒä¸èƒ½åŒ…å« MSW ä»£ç 
- âŒ ä¸èƒ½åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ Mock æ•°æ®
- âŒ ä¸èƒ½åœ¨ç”Ÿäº§ç¯å¢ƒè¾“å‡ºè°ƒè¯•æ—¥å¿—

### æ„å»ºæ£€æŸ¥

```typescript
// âœ… æ„å»ºæ—¶æ£€æŸ¥
if (process.env.NODE_ENV === 'production' && typeof window !== 'undefined') {
  if (window.location.hostname.includes('mock')) {
    throw new Error('Production build should not include mock services')
  }
}
```

## ä»£ç å®¡æŸ¥è¦ç‚¹

1. **åŠŸèƒ½å®Œæ•´æ€§**: æ˜¯å¦å®ç°äº†éœ€æ±‚
2. **ä»£ç è´¨é‡**: æ˜¯å¦é€šè¿‡æ‰€æœ‰æ£€æŸ¥
3. **æ€§èƒ½å½±å“**: æ˜¯å¦å½±å“åº”ç”¨æ€§èƒ½
4. **å®‰å…¨æ€§**: æ˜¯å¦å­˜åœ¨å®‰å…¨éšæ‚£
5. **å¯ç»´æŠ¤æ€§**: ä»£ç æ˜¯å¦æ˜“äºç†è§£å’Œç»´æŠ¤

## æœ€ç»ˆæ£€æŸ¥

ç¼–å†™å®Œä»£ç ï¼Œæœ€åéœ€è¦è¿è¡Œpnpm check è¿›è¡Œä»£ç æ ¼å¼å’Œè§„èŒƒæ£€æŸ¥ï¼Œå¦‚æœé‡åˆ°é”™è¯¯è¯·ä¿®å¤ï¼Œä¿®å¤åéœ€è¦è¿›è¡Œpnpm check éªŒè¯ï¼Œç›´åˆ°è§£å†³æ‰€æœ‰çš„é”™è¯¯ã€‚
