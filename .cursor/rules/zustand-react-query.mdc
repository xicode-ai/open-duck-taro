---
alwaysApply: false
---

# Zustand + React Query çŠ¶æ€ç®¡ç†å¼€å‘è§„èŒƒ

## æ¶æ„æ¦‚è¿°

æœ¬é¡¹ç›®é‡‡ç”¨ **Zustand** ä½œä¸ºå®¢æˆ·ç«¯çŠ¶æ€ç®¡ç† + **React Query** ä½œä¸ºæœåŠ¡ç«¯æ•°æ®çŠ¶æ€ç®¡ç†çš„æ··åˆæ¶æ„ã€‚è¿™ç§æ¶æ„å®ç°äº†å®¢æˆ·ç«¯çŠ¶æ€ä¸æœåŠ¡ç«¯çŠ¶æ€çš„æ¸…æ™°åˆ†ç¦»å’Œé«˜æ•ˆåä½œã€‚

## æ ¸å¿ƒæŠ€æœ¯æ ˆ

- **Zustand**: 5.0.7 (å®¢æˆ·ç«¯çŠ¶æ€ç®¡ç†)
- **React Query**: 5.84.2 (æœåŠ¡ç«¯æ•°æ®çŠ¶æ€ç®¡ç†)
- **æŒä¹…åŒ–**: zustand/middleware/persist
- **ç¼“å­˜ç­–ç•¥**: React Query å†…ç½®ç¼“å­˜ + Zustand æŒä¹…åŒ–
- **æ•°æ®å¤„ç†**: immer 10.1.1 (ç”¨äºå¤æ‚çŠ¶æ€æ›´æ–°)

## çŠ¶æ€ç®¡ç†èŒè´£åˆ’åˆ†

### Zustand è´Ÿè´£çš„å®¢æˆ·ç«¯çŠ¶æ€

```typescript
// âœ… å®¢æˆ·ç«¯çŠ¶æ€ç¤ºä¾‹
interface ClientState {
  // UI çŠ¶æ€
  currentPage: string
  selectedTab: string
  isModalOpen: boolean

  // ç”¨æˆ·åå¥½
  theme: 'light' | 'dark'
  language: 'zh' | 'en'
  settings: UserSettings

  // ä¸´æ—¶æ•°æ®
  formData: FormData
  tempSelections: string[]

  // è®¡ç®—çŠ¶æ€
  filteredData: Data[]
  computedStats: Stats
}
```

### React Query è´Ÿè´£çš„æœåŠ¡ç«¯çŠ¶æ€

```typescript
// âœ… æœåŠ¡ç«¯çŠ¶æ€ç¤ºä¾‹
interface ServerState {
  // API æ•°æ®
  userProfile: User
  topics: Topic[]
  vocabularies: Vocabulary[]

  // åˆ†é¡µæ•°æ®
  chatHistory: ChatMessage[]
  studyHistory: StudyRecord[]

  // å®æ—¶æ•°æ®
  liveNotifications: Notification[]
}
```

## Zustand Store å¼€å‘è§„èŒƒ

### åŸºç¡€ Store å®šä¹‰

```typescript
// âœ… æ ‡å‡† Store å®šä¹‰ - å‚è€ƒ [src/stores/topics.ts](mdc:src/stores/topics.ts)
import { create } from 'zustand'
import { persist } from 'zustand/middleware'
import { queryClient } from '@/providers/QueryProvider'
import { QUERY_KEYS } from '@/hooks/useApiQueries'
import type { Topic } from '@/types'

interface TopicState {
  // çŠ¶æ€æ•°æ®
  topics: Topic[]
  currentTopic: Topic | null
  favoriteTopics: string[]
  selectedCategory: string | null
  selectedLevel: string | null

  // Actionsï¼ˆåŠ¨ä½œæ–¹æ³•ï¼‰
  setTopics: (topics: Topic[]) => void
  setCurrentTopic: (topic: Topic | null) => void
  addTopic: (topic: Topic) => void
  updateTopic: (id: string, updates: Partial<Topic>) => void

  // æ”¶è—æ“ä½œ
  addToFavorites: (topicId: string) => void
  removeFromFavorites: (topicId: string) => void
  isFavorite: (topicId: string) => boolean

  // ç­›é€‰æ“ä½œ
  setSelectedCategory: (category: string | null) => void
  setSelectedLevel: (level: string | null) => void

  // æŸ¥è¯¢æ“ä½œ
  getTopicsByCategory: (category: string) => Topic[]
  getTopicsByLevel: (level: string) => Topic[]
  getFavoriteTopics: () => Topic[]
  getFilteredTopics: () => Topic[]
}

export const useTopicStore = create<TopicState>()(
  persist(
    (set, get) => ({
      // åˆå§‹çŠ¶æ€
      topics: [],
      currentTopic: null,
      favoriteTopics: [],
      selectedCategory: null,
      selectedLevel: null,

      // Actions å®ç°
      setTopics: (topics: Topic[]) => {
        set({ topics })
        // åŒæ­¥æ›´æ–° React Query ç¼“å­˜
        queryClient.setQueryData(QUERY_KEYS.TOPICS, topics)
      },

      setCurrentTopic: (topic: Topic | null) => {
        set({ currentTopic: topic })
        // é¢„å–ç›¸å…³æ•°æ®
        if (topic) {
          queryClient.prefetchQuery({
            queryKey: QUERY_KEYS.TOPIC_DETAIL(topic.id),
            queryFn: () => Promise.resolve(topic),
          })
        }
      },

      // å…¶ä»– actions...
    }),
    {
      name: 'topic-storage',
      // åªæŒä¹…åŒ–å¿…è¦çš„å­—æ®µ
      partialize: state => ({
        favoriteTopics: state.favoriteTopics,
        selectedCategory: state.selectedCategory,
        selectedLevel: state.selectedLevel,
      }),
    }
  )
)
```

### Zustand æœ€ä½³å®è·µ

```typescript
// âœ… ä½¿ç”¨ immer å¤„ç†å¤æ‚çŠ¶æ€æ›´æ–°
import { immer } from 'zustand/middleware/immer'

export const useComplexStore = create<ComplexState>()(
  immer((set) => ({
    data: { nested: { value: 0 } },
    updateNested: (newValue: number) =>
      set((state) => {
        state.data.nested.value = newValue
      }),
  }))
)

// âœ… çŠ¶æ€åˆ†ç‰‡ - é¿å…å•ä¸ª store è¿‡å¤§
export const useUserStore = create<UserState>()(...) // ç”¨æˆ·ç›¸å…³
export const useTopicStore = create<TopicState>()(...) // è¯é¢˜ç›¸å…³
export const useVocabularyStore = create<VocabularyState>()(...) // è¯æ±‡ç›¸å…³

// âœ… ä½¿ç”¨ subscribeWithSelector è¿›è¡Œç²¾ç¡®è®¢é˜…
import { subscribeWithSelector } from 'zustand/middleware'

export const useStore = create<State>()(
  subscribeWithSelector((set) => ({
    count: 0,
    increment: () => set((state) => ({ count: state.count + 1 })),
  }))
)

// ç»„ä»¶ä¸­ç²¾ç¡®è®¢é˜…
const count = useStore((state) => state.count)
```

### Zustand ä¸ React Query é›†æˆè§„èŒƒ

```typescript
// âœ… åœ¨ Zustand actions ä¸­åŒæ­¥ React Query ç¼“å­˜
const setTopics: (topics: Topic[]) => {
  set({ topics })
  // åŒæ­¥æ›´æ–° React Query ç¼“å­˜
  queryClient.setQueryData(QUERY_KEYS.TOPICS, topics)
}

// âœ… é¢„å–ç›¸å…³æ•°æ®
const setCurrentTopic: (topic: Topic | null) => {
  set({ currentTopic: topic })
  // é¢„å–è¯é¢˜è¯¦æƒ…
  if (topic) {
    queryClient.prefetchQuery({
      queryKey: QUERY_KEYS.TOPIC_DETAIL(topic.id),
      queryFn: () => topicApi.getTopicDetail(topic.id),
    })
  }
}

// âœ… æ¸…ç†ç¼“å­˜
const logout: () => {
  set({ user: null, isLoggedIn: false })
  // æ¸…é™¤æ‰€æœ‰ç”¨æˆ·ç›¸å…³ç¼“å­˜
  queryClient.removeQueries({ queryKey: QUERY_KEYS.USER })
}
```

## React Query å¼€å‘è§„èŒƒ

### Query Keys ç®¡ç†

```typescript
// âœ… ç»Ÿä¸€çš„ Query Keys å®šä¹‰ - å‚è€ƒ [src/hooks/useApiQueries.ts](mdc:src/hooks/useApiQueries.ts)
export const QUERY_KEYS = {
  // ç”¨æˆ·ç›¸å…³
  USER: ['user'] as const,
  USER_PROFILE: (userId?: string) => ['user', 'profile', userId] as const,
  USER_STATS: ['user', 'stats'] as const,

  // è¯é¢˜ç›¸å…³
  TOPICS: ['topics'] as const,
  TOPIC_DETAIL: (topicId: string) => ['topics', 'detail', topicId] as const,
  TOPIC_DIALOGUES: (topicId: string) =>
    ['topics', 'dialogues', topicId] as const,

  // è¯æ±‡ç›¸å…³
  VOCABULARIES: ['vocabularies'] as const,
  VOCABULARY_BY_LEVEL: (level: string) =>
    ['vocabularies', 'level', level] as const,
} as const
```

### æŸ¥è¯¢ Hooks è§„èŒƒ

```typescript
// âœ… æ ‡å‡†æŸ¥è¯¢ Hook
export const useUserInfo = () => {
  return useQuery({
    queryKey: QUERY_KEYS.USER_PROFILE(),
    queryFn: async () => {
      const response = await userApi.getUserInfo()
      return response.data // è¿”å›å®é™…æ•°æ®ï¼Œä¸æ˜¯ ApiResponse åŒ…è£…
    },
    staleTime: 10 * 60 * 1000, // 10åˆ†é’Ÿå†…è®¤ä¸ºæ•°æ®æ˜¯æ–°é²œçš„
    gcTime: 30 * 60 * 1000, // 30åˆ†é’Ÿåæ¸…ç†ç¼“å­˜
  })
}

// âœ… å¸¦å‚æ•°çš„æŸ¥è¯¢
export const useTopics = (category?: string, level?: string) => {
  return useQuery({
    queryKey: [...QUERY_KEYS.TOPICS, { category, level }],
    queryFn: async () => {
      const response = await topicApi.getTopics({ category, level })
      return response.data
    },
    enabled: true, // å¯ä»¥æ ¹æ®æ¡ä»¶æ§åˆ¶æ˜¯å¦å¯ç”¨
    staleTime: 15 * 60 * 1000,
  })
}

// âœ… æ¡ä»¶æŸ¥è¯¢
export const useTopicDetail = (topicId: string) => {
  return useQuery({
    queryKey: QUERY_KEYS.TOPIC_DETAIL(topicId),
    queryFn: async () => {
      const response = await topicApi.getTopicDetail(topicId)
      return response.data
    },
    enabled: !!topicId, // åªæœ‰å½“ topicId å­˜åœ¨æ—¶æ‰æ‰§è¡ŒæŸ¥è¯¢
    staleTime: 30 * 60 * 1000,
  })
}
```

### å˜æ›´ Hooks è§„èŒƒ

```typescript
// âœ… æ ‡å‡†å˜æ›´ Hook
export const useUpdateUserInfo = () => {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async (userInfo: Partial<User>) => {
      const response = await userApi.updateUserInfo(userInfo)
      return response.data
    },
    onSuccess: data => {
      // æ›´æ–°ç”¨æˆ·ä¿¡æ¯ç¼“å­˜
      queryClient.setQueryData(QUERY_KEYS.USER_PROFILE(), data)
      // ä½¿ç›¸å…³æŸ¥è¯¢å¤±æ•ˆ
      queryClient.invalidateQueries({ queryKey: QUERY_KEYS.USER })
    },
    onError: error => {
      // ç»Ÿä¸€é”™è¯¯å¤„ç†
      console.error('æ›´æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error)
    },
  })
}

// âœ… å¸¦ä¹è§‚æ›´æ–°çš„å˜æ›´
export const useToggleFavorite = () => {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: ({
      topicId,
      isFavorite,
    }: {
      topicId: string
      isFavorite: boolean
    }) => topicApi.toggleFavorite(topicId, isFavorite),

    // ä¹è§‚æ›´æ–°
    onMutate: async ({ topicId, isFavorite }) => {
      // å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„æŸ¥è¯¢
      await queryClient.cancelQueries({ queryKey: QUERY_KEYS.TOPICS })

      // ä¿å­˜ä¹‹å‰çš„æ•°æ®
      const previousTopics = queryClient.getQueryData(QUERY_KEYS.TOPICS)

      // ä¹è§‚æ›´æ–°
      queryClient.setQueryData(QUERY_KEYS.TOPICS, (old: Topic[]) =>
        old?.map(topic =>
          topic.id === topicId ? { ...topic, isFavorite } : topic
        )
      )

      return { previousTopics }
    },

    // é”™è¯¯å›æ»š
    onError: (err, variables, context) => {
      if (context?.previousTopics) {
        queryClient.setQueryData(QUERY_KEYS.TOPICS, context.previousTopics)
      }
    },

    // æœ€ç»ˆåŒæ­¥
    onSettled: () => {
      queryClient.invalidateQueries({ queryKey: QUERY_KEYS.TOPICS })
    },
  })
}
```

### React Query é…ç½®è§„èŒƒ

```typescript
// âœ… QueryClient é…ç½® - å‚è€ƒ [src/providers/QueryProvider.tsx](mdc:src/providers/QueryProvider.tsx)
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      // æ•°æ®ä¿æŒæ–°é²œçš„æ—¶é—´ï¼ˆ5åˆ†é’Ÿï¼‰
      staleTime: 5 * 60 * 1000,
      // ç¼“å­˜æ—¶é—´ï¼ˆ30åˆ†é’Ÿï¼‰
      gcTime: 30 * 60 * 1000,
      // é‡è¯•é…ç½®
      retry: (failureCount, error: Error) => {
        // ç½‘ç»œé”™è¯¯é‡è¯•ï¼Œå…¶ä»–é”™è¯¯ä¸é‡è¯•
        if (error?.message?.includes('network') && failureCount < 3) {
          return true
        }
        return false
      },
      // é‡è¯•å»¶è¿Ÿï¼ˆæŒ‡æ•°é€€é¿ï¼‰
      retryDelay: attemptIndex => Math.min(1000 * 2 ** attemptIndex, 30000),
      // çª—å£é‡æ–°è·å¾—ç„¦ç‚¹æ—¶ä¸è‡ªåŠ¨é‡æ–°è·å–
      refetchOnWindowFocus: false,
      // ç½‘ç»œé‡è¿æ—¶é‡æ–°è·å–
      refetchOnReconnect: true,
    },
    mutations: {
      // å˜æ›´é‡è¯•é…ç½®
      retry: 1,
    },
  },
})
```

### æ•°æ®é¢„å–å’Œç¼“å­˜ç­–ç•¥

```typescript
// âœ… æ•°æ®é¢„å–å·¥å…·
export const usePrefetchData = () => {
  const queryClient = useQueryClient()

  const prefetchUserData = (userId?: string) => {
    queryClient.prefetchQuery({
      queryKey: QUERY_KEYS.USER_PROFILE(userId),
      queryFn: () => userApi.getUserInfo(),
    })

    queryClient.prefetchQuery({
      queryKey: QUERY_KEYS.USER_STATS,
      queryFn: () => userApi.getStudyStats(),
    })
  }

  const prefetchTopics = () => {
    queryClient.prefetchQuery({
      queryKey: QUERY_KEYS.TOPICS,
      queryFn: () => topicApi.getTopics({}),
    })
  }

  return { prefetchUserData, prefetchTopics }
}

// âœ… åœ¨ç»„ä»¶ä¸­ä½¿ç”¨é¢„å–
const HomePage = () => {
  const { prefetchTopics } = usePrefetchData()

  useEffect(() => {
    // é¢„å–ç”¨æˆ·å¯èƒ½éœ€è¦çš„æ•°æ®
    prefetchTopics()
  }, [prefetchTopics])

  return <div>...</div>
}
```

## çŠ¶æ€ç®¡ç†æ¶æ„åŸåˆ™

### æ•°æ®æµè®¾è®¡

```
ç”¨æˆ·æ“ä½œ â†’ Zustand Action â†’ åŒæ­¥ React Query ç¼“å­˜ â†’ UI æ›´æ–°
     â†“
API è°ƒç”¨ â†’ React Query Hook â†’ è‡ªåŠ¨ç¼“å­˜ â†’ åå°æ›´æ–°
```

### èŒè´£åˆ†ç¦»

- **Zustand**: ç®¡ç†å®¢æˆ·ç«¯çŠ¶æ€ï¼ˆUI çŠ¶æ€ã€ç”¨æˆ·åå¥½ã€ä¸´æ—¶æ•°æ®ï¼‰
- **React Query**: ç®¡ç†æœåŠ¡ç«¯çŠ¶æ€ï¼ˆAPI æ•°æ®ã€ç¼“å­˜ã€åŒæ­¥ï¼‰
- **åŒå‘åŒæ­¥**: Zustand æ›´æ–°æ—¶åŒæ­¥ React Queryï¼ŒReact Query æ•°æ®å˜æ›´æ—¶å¯é€‰æ‹©æ€§æ›´æ–° Zustand

### ç¼“å­˜ç­–ç•¥

```typescript
// âœ… ä¸åŒæ•°æ®çš„ç¼“å­˜ç­–ç•¥
const cacheStrategies = {
  // ç”¨æˆ·ä¿¡æ¯ - é•¿ç¼“å­˜
  userInfo: { staleTime: 30 * 60 * 1000, gcTime: 60 * 60 * 1000 },

  // è¯é¢˜åˆ—è¡¨ - ä¸­ç­‰ç¼“å­˜
  topics: { staleTime: 15 * 60 * 1000, gcTime: 30 * 60 * 1000 },

  // èŠå¤©æ¶ˆæ¯ - çŸ­ç¼“å­˜
  chatMessages: { staleTime: 2 * 60 * 1000, gcTime: 10 * 60 * 1000 },

  // å®æ—¶æ•°æ® - ä¸ç¼“å­˜
  liveData: { staleTime: 0, gcTime: 0 },
}
```

## ç»„ä»¶ä½¿ç”¨è§„èŒƒ

### åœ¨ç»„ä»¶ä¸­ä½¿ç”¨çŠ¶æ€

```typescript
// âœ… ç»„ä»¶ä¸­ä½¿ç”¨çŠ¶æ€
const TopicList = () => {
  // ä½¿ç”¨ React Query è·å–æœåŠ¡ç«¯æ•°æ®
  const { data: topics, isLoading } = useTopics()

  // ä½¿ç”¨ Zustand ç®¡ç†å®¢æˆ·ç«¯çŠ¶æ€
  const {
    selectedCategory,
    setSelectedCategory,
    getFilteredTopics
  } = useTopicStore()

  // è®¡ç®—æ´¾ç”ŸçŠ¶æ€
  const filteredTopics = useMemo(() => {
    return getFilteredTopics()
  }, [topics, selectedCategory])

  if (isLoading) return <Loading />

  return (
    <div>
      {filteredTopics.map(topic => (
        <TopicCard key={topic.id} topic={topic} />
      ))}
    </div>
  )
}
```

### é”™è¯¯å¤„ç†å’ŒåŠ è½½çŠ¶æ€

```typescript
// âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
const UserProfile = () => {
  const {
    data: userInfo,
    isLoading,
    error,
    refetch
  } = useUserInfo()

  if (isLoading) {
    return <AtLoadMore status="loading" />
  }

  if (error) {
    return (
      <View className="error-container">
        <Text className="error-text">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</Text>
        <View className="retry-button" onClick={() => refetch()}>
          é‡è¯•
        </View>
      </View>
    )
  }

  return (
    <View>
      <Text>{userInfo?.nickname}</Text>
    </View>
  )
}

// âœ… å˜æ›´çŠ¶æ€å¤„ç†
const UpdateButton = () => {
  const updateUser = useUpdateUserInfo()

  const handleUpdate = async () => {
    try {
      await updateUser.mutateAsync({ nickname: 'æ–°æ˜µç§°' })
      Taro.showToast({ title: 'æ›´æ–°æˆåŠŸ', icon: 'success' })
    } catch (error) {
      Taro.showToast({ title: 'æ›´æ–°å¤±è´¥', icon: 'error' })
    }
  }

  return (
    <button
      onClick={handleUpdate}
      disabled={updateUser.isPending}
    >
      {updateUser.isPending ? 'æ›´æ–°ä¸­...' : 'æ›´æ–°'}
    </button>
  )
}
```

## æ€§èƒ½ä¼˜åŒ–è§„èŒƒ

### é¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“

```typescript
// âœ… ä½¿ç”¨ React.memo å’Œç²¾ç¡®è®¢é˜…
const TopicCard = React.memo<TopicCardProps>(({ topic, onSelect }) => {
  // åªè®¢é˜…éœ€è¦çš„çŠ¶æ€
  const isFavorite = useTopicStore(state =>
    state.favoriteTopics.includes(topic.id)
  )

  const toggleFavorite = useTopicStore(state => state.toggleFavorite)

  return (
    <div onClick={() => onSelect(topic.id)}>
      <h3>{topic.title}</h3>
      <button onClick={() => toggleFavorite(topic.id)}>
        {isFavorite ? 'â¤ï¸' : 'ğŸ¤'}
      </button>
    </div>
  )
})

// âœ… ä½¿ç”¨ useMemo ç¼“å­˜è®¡ç®—ç»“æœ
const TopicList = () => {
  const topics = useTopics()
  const { selectedCategory } = useTopicStore()

  const filteredTopics = useMemo(() => {
    return topics.data?.filter(topic =>
      !selectedCategory || topic.category === selectedCategory
    ) || []
  }, [topics.data, selectedCategory])

  return (
    <div>
      {filteredTopics.map(topic => (
        <TopicCard key={topic.id} topic={topic} />
      ))}
    </div>
  )
}
```

### æ•°æ®é¢„åŠ è½½

```typescript
// âœ… åœ¨è·¯ç”±åˆ‡æ¢æ—¶é¢„åŠ è½½æ•°æ®
const App = () => {
  const { prefetchTopics, prefetchUserData } = usePrefetchData()

  useEffect(() => {
    // åº”ç”¨å¯åŠ¨æ—¶é¢„åŠ è½½å…³é”®æ•°æ®
    prefetchUserData()
    prefetchTopics()
  }, [])

  return <Router />
}

// âœ… åœ¨ç”¨æˆ·äº¤äº’æ—¶é¢„åŠ è½½ç›¸å…³æ•°æ®
const TopicCard = ({ topic }) => {
  const { prefetchTopicDetail } = usePrefetchData()

  const handleHover = () => {
    // é¼ æ ‡æ‚¬åœæ—¶é¢„åŠ è½½è¯¦æƒ…
    prefetchTopicDetail(topic.id)
  }

  return (
    <div onMouseEnter={handleHover}>
      {topic.title}
    </div>
  )
}
```

## æµ‹è¯•è§„èŒƒ

### Store æµ‹è¯•

```typescript
// âœ… Zustand Store æµ‹è¯•
import { renderHook, act } from '@testing-library/react'
import { useTopicStore } from '@/stores/topics'

describe('useTopicStore', () => {
  beforeEach(() => {
    // é‡ç½® store çŠ¶æ€
    useTopicStore.setState({
      topics: [],
      favoriteTopics: [],
    })
  })

  it('should add topic to favorites', () => {
    const { result } = renderHook(() => useTopicStore())

    act(() => {
      result.current.addToFavorites('topic-1')
    })

    expect(result.current.favoriteTopics).toContain('topic-1')
  })

  it('should filter topics by category', () => {
    const { result } = renderHook(() => useTopicStore())

    act(() => {
      result.current.setTopics([
        { id: '1', category: 'travel', title: 'Travel' },
        { id: '2', category: 'food', title: 'Food' },
      ])
    })

    const travelTopics = result.current.getTopicsByCategory('travel')
    expect(travelTopics).toHaveLength(1)
    expect(travelTopics[0].id).toBe('1')
  })
})
```

### React Query æµ‹è¯•

```typescript
// âœ… React Query Hook æµ‹è¯•
import { renderHook, waitFor } from '@testing-library/react'
import { QueryClient, QueryClientProvider } from '@tanstack/react-query'
import { useTopics } from '@/hooks/useApiQueries'

const createWrapper = () => {
  const queryClient = new QueryClient({
    defaultOptions: {
      queries: { retry: false },
    },
  })
  return ({ children }) => (
    <QueryClientProvider client={queryClient}>
      {children}
    </QueryClientProvider>
  )
}

describe('useTopics', () => {
  it('should fetch topics successfully', async () => {
    const { result } = renderHook(() => useTopics(), {
      wrapper: createWrapper(),
    })

    await waitFor(() => {
      expect(result.current.isSuccess).toBe(true)
    })

    expect(result.current.data).toBeDefined()
  })
})
```

## è°ƒè¯•å’Œå¼€å‘å·¥å…·

### React Query DevTools

```typescript
// âœ… å¼€å‘ç¯å¢ƒå¯ç”¨ DevTools
import { ReactQueryDevtools } from '@tanstack/react-query-devtools'

const App = () => {
  return (
    <QueryClientProvider client={queryClient}>
      <Router />
      {process.env.NODE_ENV === 'development' && (
        <ReactQueryDevtools initialIsOpen={false} />
      )}
    </QueryClientProvider>
  )
}
```

### Zustand DevTools

```typescript
// âœ… å¼€å‘ç¯å¢ƒå¯ç”¨ Zustand DevTools
import { devtools } from 'zustand/middleware'

export const useTopicStore = create<TopicState>()(
  devtools(
    persist(
      (set, get) => ({
        // store implementation
      }),
      {
        name: 'topic-storage',
      }
    ),
    {
      name: 'topic-store',
    }
  )
)
```

## å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### 1. çŠ¶æ€åŒæ­¥é—®é¢˜

```typescript
// âŒ é”™è¯¯ï¼šç›´æ¥ä¿®æ”¹ React Query ç¼“å­˜
const updateTopic = (id: string, updates: Partial<Topic>) => {
  const topics = queryClient.getQueryData(QUERY_KEYS.TOPICS)
  queryClient.setQueryData(
    QUERY_KEYS.TOPICS,
    topics.map(t => (t.id === id ? { ...t, ...updates } : t))
  )
}

// âœ… æ­£ç¡®ï¼šé€šè¿‡ Zustand ç»Ÿä¸€ç®¡ç†
const updateTopic = (id: string, updates: Partial<Topic>) => {
  set(state => ({
    topics: state.topics.map(topic =>
      topic.id === id ? { ...topic, ...updates } : topic
    ),
  }))
  // ä½¿ç›¸å…³æŸ¥è¯¢å¤±æ•ˆï¼Œè®© React Query é‡æ–°è·å–
  queryClient.invalidateQueries({ queryKey: QUERY_KEYS.TOPICS })
}
```

### 2. ç¼“å­˜å¤±æ•ˆç­–ç•¥

```typescript
// âœ… ç²¾ç¡®çš„ç¼“å­˜å¤±æ•ˆ
const updateUserProfile = (updates: Partial<User>) => {
  // æ›´æ–° Zustand çŠ¶æ€
  set(state => ({ user: { ...state.user, ...updates } }))

  // æ›´æ–°ç›¸å…³ç¼“å­˜
  queryClient.setQueryData(QUERY_KEYS.USER_PROFILE(), updates)

  // ä½¿ç›¸å…³æŸ¥è¯¢å¤±æ•ˆ
  queryClient.invalidateQueries({ queryKey: QUERY_KEYS.USER })
  queryClient.invalidateQueries({ queryKey: QUERY_KEYS.USER_STATS })
}
```

### 3. å†…å­˜æ³„æ¼é¢„é˜²

```typescript
// âœ… ç»„ä»¶å¸è½½æ—¶æ¸…ç†
const TopicDetail = ({ topicId }: { topicId: string }) => {
  const { data, isLoading } = useTopicDetail(topicId)

  useEffect(() => {
    return () => {
      // ç»„ä»¶å¸è½½æ—¶æ¸…ç†ç›¸å…³ç¼“å­˜
      queryClient.removeQueries({
        queryKey: QUERY_KEYS.TOPIC_DETAIL(topicId)
      })
    }
  }, [topicId])

  return <div>{data?.title}</div>
}
```

## æœ€ä½³å®è·µæ€»ç»“

1. **èŒè´£æ¸…æ™°**: Zustand ç®¡ç†å®¢æˆ·ç«¯çŠ¶æ€ï¼ŒReact Query ç®¡ç†æœåŠ¡ç«¯çŠ¶æ€
2. **æ•°æ®åŒæ­¥**: é€šè¿‡ Zustand actions åŒæ­¥æ›´æ–° React Query ç¼“å­˜
3. **ç¼“å­˜ç­–ç•¥**: æ ¹æ®æ•°æ®ç‰¹æ€§è®¾ç½®åˆé€‚çš„ç¼“å­˜æ—¶é—´
4. **æ€§èƒ½ä¼˜åŒ–**: ä½¿ç”¨ç²¾ç¡®è®¢é˜…å’Œé¢„åŠ è½½æå‡ç”¨æˆ·ä½“éªŒ
5. **é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’ŒåŠ è½½çŠ¶æ€ç®¡ç†
6. **æµ‹è¯•è¦†ç›–**: å®Œæ•´çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
7. **å¼€å‘å·¥å…·**: å……åˆ†åˆ©ç”¨ DevTools è¿›è¡Œè°ƒè¯•

éµå¾ªè¿™äº›è§„èŒƒå¯ä»¥ç¡®ä¿çŠ¶æ€ç®¡ç†çš„å¯ç»´æŠ¤æ€§ã€æ€§èƒ½å’Œå¼€å‘æ•ˆç‡ã€‚
