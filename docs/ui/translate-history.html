<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>翻译历史 - 开口鸭</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .scroll-container {
        overflow-y: auto;
        scrollbar-width: none; /* for Firefox */
        -ms-overflow-style: none; /* for Internet Explorer and Edge */
      }
      .scroll-container::-webkit-scrollbar {
        display: none; /* for Chrome, Safari, and Opera */
      }
    </style>
  </head>
  <body class="bg-gray-100 h-screen flex flex-col">
    <script src="auth.js"></script>

    <!-- iOS状态栏 -->
    <div class="bg-white h-11 flex items-center justify-between px-4 text-sm font-medium">
      <div class="flex items-center space-x-1">
        <span>9:41</span>
      </div>
      <div class="w-16 h-4 bg-black rounded-full relative">
        <div class="absolute right-0 top-0 w-1 h-1 bg-white rounded-full m-1"></div>
      </div>
      <div class="flex items-center space-x-1">
        <i class="fas fa-signal text-xs"></i>
        <i class="fas fa-wifi text-xs"></i>
        <i class="fas fa-battery-three-quarters text-xs"></i>
      </div>
    </div>

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between">
      <button
        onclick="history.back()"
        class="text-gray-600 w-8 h-8 flex items-center justify-center"
      >
        <i class="fas fa-arrow-left"></i>
      </button>
      <h1 class="text-lg font-semibold text-gray-800">翻译历史</h1>
      <div class="w-8"></div>
      <!-- Placeholder for alignment -->
    </header>

    <!-- Main Content -->
    <main class="flex-1 px-4 pt-4 pb-4 scroll-container">
      <div id="history-list" class="space-y-4">
        <!-- 翻译历史将动态插入此处 -->
      </div>
      <div
        id="empty-state"
        class="hidden flex flex-col items-center justify-center h-full text-gray-400"
      >
        <i class="fas fa-history text-5xl mb-4"></i>
        <p class="text-sm">还没有翻译记录哦</p>
      </div>
    </main>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const historyList = document.getElementById('history-list')
        const emptyState = document.getElementById('empty-state')

        // For testing - 示例数据格式 (取消注释以查看效果)
        localStorage.setItem(
          'translationHistory',
          JSON.stringify([
            {
              sourceText: '我想去咖啡店买一杯拿铁',
              standardTranslation: 'I want to go to a coffee shop to buy a latte.',
              colloquialTranslation: "Hey, I'd like to grab a latte from the coffee shop.",
              colloquialNotes:
                '• "grab a latte" 比 "buy a latte" 更口语化\n• "Hey" 让对话更亲切自然',
              timestamp: new Date().toISOString(),
            },
            {
              sourceText: '这个多少钱？',
              standardTranslation: 'How much does this cost?',
              colloquialTranslation: 'How much is this?',
              colloquialNotes: '• 更简洁直接的表达方式\n• 日常购物常用句型',
              timestamp: new Date(Date.now() - 86400000).toISOString(),
            },
            {
              sourceText: '谢谢你的帮助',
              standardTranslation: 'Thank you for your help.',
              colloquialTranslation: 'Thanks for helping me out!',
              colloquialNotes: '• "Thanks" 比 "Thank you" 更随意\n• "helping me out" 更口语化',
              timestamp: new Date(Date.now() - 172800000).toISOString(),
            },
          ]),
        )

        const translationHistory = JSON.parse(localStorage.getItem('translationHistory')) || []

        if (translationHistory.length === 0) {
          emptyState.classList.remove('hidden')
          emptyState.classList.add('flex')
        } else {
          const groupedByDate = translationHistory.reduce((acc, item) => {
            const date = new Date(item.timestamp).toLocaleDateString('zh-CN', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
            })
            if (!acc[date]) {
              acc[date] = []
            }
            acc[date].push(item)
            return acc
          }, {})

          const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(b) - new Date(a))

          let html = ''
          sortedDates.forEach((date) => {
            html += `<div class="mb-6">`
            html += `<h2 class="text-sm font-semibold text-gray-500 px-2 mb-3">${getRelativeDate(date)}</h2>`
            html += `<div class="space-y-4">`
            groupedByDate[date].reverse().forEach((item) => {
              html += createHistoryItemHTML(item)
            })
            html += `</div></div>`
          })
          historyList.innerHTML = html
        }
      })

      function createHistoryItemHTML(item) {
        // 处理旧格式的数据兼容性
        const standardTranslation = item.standardTranslation || item.translatedText || ''
        const colloquialTranslation = item.colloquialTranslation || ''
        const colloquialNotes = item.colloquialNotes || ''

        console.log('创建历史项目:', {
          sourceText: item.sourceText,
          standardTranslation,
          colloquialTranslation,
          colloquialNotes,
        })

        return `
                <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 mb-4">
                    <!-- 原文 -->
                    <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                        <p class="text-gray-800 font-medium">${item.sourceText}</p>
                    </div>

                    <!-- 标准翻译 -->
                    <div class="mb-4">
                        <div class="flex items-center space-x-2 mb-2">
                            <div class="w-6 h-6 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-book text-blue-500 text-xs"></i>
                            </div>
                            <span class="font-semibold text-gray-800 text-sm">标准翻译</span>
                            <span class="bg-blue-100 text-blue-600 px-2 py-1 rounded text-xs">书面语</span>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-3">
                            <p class="text-gray-800 text-sm leading-relaxed mb-3">${standardTranslation || '暂无标准翻译'}</p>
                            <div class="flex justify-start">
                                <button class="bg-blue-100 text-blue-600 w-7 h-7 rounded-lg flex items-center justify-center hover:bg-blue-200 transition-colors">
                                    <i class="fas fa-volume-up text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 地道口语 -->
                    <div class="mb-3">
                        <div class="flex items-center space-x-2 mb-2">
                            <div class="w-6 h-6 bg-green-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-comments text-green-500 text-xs"></i>
                            </div>
                            <span class="font-semibold text-gray-800 text-sm">地道口语</span>
                            <span class="bg-green-100 text-green-600 px-2 py-1 rounded text-xs">推荐</span>
                        </div>
                        <div class="bg-green-50 rounded-lg p-3">
                            <p class="text-gray-800 text-sm leading-relaxed mb-2">${colloquialTranslation || '暂无地道口语翻译'}</p>
                            ${
                              colloquialNotes
                                ? `
                            <div class="border-t border-green-200 pt-2 mt-2 mb-3">
                                <p class="text-green-700 text-xs font-medium mb-1">更自然的表达:</p>
                                <p class="text-green-600 text-xs">${colloquialNotes.replace(/\n/g, '<br>')}</p>
                            </div>
                            `
                                : ''
                            }
                            <div class="flex justify-start">
                                <button class="bg-green-100 text-green-600 w-7 h-7 rounded-lg flex items-center justify-center hover:bg-green-200 transition-colors">
                                    <i class="fas fa-volume-up text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 操作按钮 -->
                    <div class="flex items-center justify-between pt-2 border-t border-gray-100">
                        <button class="bg-gray-100 text-gray-600 w-8 h-8 rounded-lg flex items-center justify-center hover:bg-gray-200 transition-colors" onclick="copyText('${standardTranslation || colloquialTranslation}')">
                            <i class="fas fa-copy text-sm"></i>
                        </button>
                        <span class="text-xs text-gray-400">${formatTime(item.timestamp)}</span>
                    </div>
                </div>
            `
      }

      function getRelativeDate(dateString) {
        const historyDate = new Date(dateString)
        const today = new Date()
        const yesterday = new Date(today)
        yesterday.setDate(yesterday.getDate() - 1)

        if (historyDate.toDateString() === today.toDateString()) {
          return '今天'
        }
        if (historyDate.toDateString() === yesterday.toDateString()) {
          return '昨天'
        }
        return dateString
      }

      function formatTime(timestamp) {
        return new Date(timestamp).toLocaleTimeString('zh-CN', {
          hour: '2-digit',
          minute: '2-digit',
        })
      }

      function copyText(text) {
        navigator.clipboard.writeText(text).then(() => {
          // 简单的复制成功提示
          const originalText = event.target.innerHTML
          event.target.innerHTML = '<i class="fas fa-check mr-1"></i>已复制'
          setTimeout(() => {
            event.target.innerHTML = originalText
          }, 1000)
        })
      }
    </script>
  </body>
</html>
